---
- import_tasks: pre-check.yml

- import_tasks: init.yml

- name: Generate DC/OS Download url
  set_fact:
    dcos_download_server: "{% if dcos_deploy_ee_package==False %}downloads.dcos.io/dcos/stable{% else %}downloads.mesosphere.com/dcos-enterprise/stable{% endif %}"
    dcos_download_file: "{% if dcos_deploy_ee_package==False %}dcos_generate_config.sh{% else %}dcos_generate_config.ee.sh{% endif %}"

- name: Download DC/OS installation file
  get_url: url="https://{{ dcos_download_server }}/{{ dcos_version }}/{{ dcos_download_file }}" dest={{ dcos_path_bootstrap }}/dcos_generate_config.sh mode=0440 force=yes

- name: Generate IP detection script.
  template: src=ip-detect-{{ dcos_iaas_target }}.j2 dest={{ dcos_path_bootstrap }}/genconf/ip-detect mode=0644

- name: Set Public IP detection script.
  template: src=ip-detect-public-{{ dcos_iaas_target }}.j2 dest={{ dcos_path_bootstrap }}/genconf/ip-detect-public mode=0644
  when: dcos_iaas_target != "onprem"

- name: Generate DC/OS configuration
  template: src=config.yaml.j2 dest={{ dcos_path_bootstrap }}/genconf/config.yaml mode=0644

- name: Set Fault Domain detection script
  copy: src=fault-domain-detect dest={{ dcos_path_bootstrap }}/genconf/fault-domain-detect mode=0644
  when: dcos_iaas_target != "onprem"

- name: Generate DC/OS bootstrap files
  shell: "bash dcos_generate_config.sh"
  args:
    chdir: "{{ dcos_path_bootstrap }}"
  when: dcos_upgrade == False

- import_tasks: upgrade.yml
  when: dcos_upgrade == True

- name: Start web server to serve the bootstrap files
  docker_container:
    name: dcos_nginx
    image: nginx
    state: started
    recreate: yes
    restart: yes
    ports:
    - "{{ dcos_port_webserver }}:80"
    volumes:
    - "{{ dcos_path_bootstrap }}/genconf/serve:/usr/share/nginx/html:ro"
